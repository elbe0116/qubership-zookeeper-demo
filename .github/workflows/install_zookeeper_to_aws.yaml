name: Install ZooKeeper

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment Name"
        required: false
        default: "dev"
      test_tags:
        description: "Test tags to run (e.g. zookeeper_crud, zookeeper_backup, or empty for all)"
        required: false
        default: ""

jobs:
  Install-ZooKeeper:
    environment: "${{github.event.inputs.environment}}"
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Listing downloaded files
        run: |
          pwd
          ls -R ./

      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.32.0'

      - name: Setup Helm
        uses: azure/setup-helm@v3

      - name: Verify tools
        run: |
          kubectl version --client
          helm version
          aws --version

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ vars.AWS_REGION || 'us-east-1' }}

      - name: Configure kubeconfig for EKS
        run: |
          aws eks update-kubeconfig --region ${{ vars.AWS_REGION || 'us-east-1' }} --name ${{ vars.AWS_CLUSTERNAME }}

      - name: Verify cluster access
        run: kubectl get nodes

      - name: Install ZooKeeper
        run: |
          echo "Clean previously installed ZooKeeper"
          kubectl delete ns ${{ vars.ZOOKEEPER_INSTALL_NAMESPACE }} || true
          echo "Namespace to install: ${{ vars.ZOOKEEPER_INSTALL_NAMESPACE }}"
          
          # Build helm arguments dynamically (only add non-empty values)
          HELM_ARGS=""
          
          # Enable integration tests and set test tags (empty = all tests)
          HELM_ARGS="$HELM_ARGS --set integrationTests.install=true"
          HELM_ARGS="$HELM_ARGS --set integrationTests.tags=${{ github.event.inputs.test_tags }}"
          
          # Secrets - S3 credentials for test results upload
          [ -n "${{ secrets.S3_AWS_ACCESS_KEY_ID }}" ] && HELM_ARGS="$HELM_ARGS --set integrationTests.atpStorage.username=${{ secrets.S3_AWS_ACCESS_KEY_ID }}"
          [ -n "${{ secrets.S3_AWS_SECRET_ACCESS_KEY }}" ] && HELM_ARGS="$HELM_ARGS --set integrationTests.atpStorage.password=${{ secrets.S3_AWS_SECRET_ACCESS_KEY }}"
          
          # Secrets - S3 credentials for backup daemon
          [ -n "${{ secrets.S3_AWS_ACCESS_KEY_ID }}" ] && HELM_ARGS="$HELM_ARGS --set backupDaemon.s3.keyId=${{ secrets.S3_AWS_ACCESS_KEY_ID }}"
          [ -n "${{ secrets.S3_AWS_SECRET_ACCESS_KEY }}" ] && HELM_ARGS="$HELM_ARGS --set backupDaemon.s3.keySecret=${{ secrets.S3_AWS_SECRET_ACCESS_KEY }}"
          
          # Variables (only add if set, otherwise use values.yaml defaults)
          [ -n "${{ vars.ATP_STORAGE_PROVIDER }}" ] && HELM_ARGS="$HELM_ARGS --set integrationTests.atpStorage.provider=${{ vars.ATP_STORAGE_PROVIDER }}"
          [ -n "${{ vars.ATP_STORAGE_SERVER_URL }}" ] && HELM_ARGS="$HELM_ARGS --set integrationTests.atpStorage.serverUrl=${{ vars.ATP_STORAGE_SERVER_URL }}"
          [ -n "${{ vars.ATP_STORAGE_SERVER_UI_URL }}" ] && HELM_ARGS="$HELM_ARGS --set integrationTests.atpStorage.serverUiUrl=${{ vars.ATP_STORAGE_SERVER_UI_URL }}"
          [ -n "${{ vars.ATP_STORAGE_BUCKET }}" ] && HELM_ARGS="$HELM_ARGS --set integrationTests.atpStorage.bucket=${{ vars.ATP_STORAGE_BUCKET }}"
          [ -n "${{ vars.AWS_REGION }}" ] && HELM_ARGS="$HELM_ARGS --set integrationTests.atpStorage.region=${{ vars.AWS_REGION }}"
          [ -n "${{ vars.ATP_REPORT_VIEW_UI_URL }}" ] && HELM_ARGS="$HELM_ARGS --set integrationTests.atpReportViewUiUrl=${{ vars.ATP_REPORT_VIEW_UI_URL }}"
          
          # Environment name (use input or variable)
          ENV_NAME="${{ vars.ENVIRONMENT_NAME }}"
          [ -z "$ENV_NAME" ] && ENV_NAME="${{ github.event.inputs.environment }}"
          [ -n "$ENV_NAME" ] && HELM_ARGS="$HELM_ARGS --set integrationTests.environmentName=$ENV_NAME"
          
          # MONITORED_IMAGES for zookeeper_images test
          # Format requires registry:port so split by ':' gives 3 parts (test uses parts[-1] for tag)
          # Using temp file to avoid shell escaping issues with spaces and special chars
          cat > /tmp/monitored-images-values.yaml << 'EOF'
          integrationTests:
            monitoredImages: "deployment zookeeper-service-operator zookeeper-service-operator ghcr.io:443/netcracker/qubership-zookeeper-operator:main,deployment zookeeper-1 zookeeper ghcr.io:443/netcracker/qubership-docker-zookeeper:main,deployment zookeeper-monitoring zookeeper-monitoring ghcr.io:443/netcracker/qubership-zookeeper-monitoring:main,deployment zookeeper-backup-daemon zookeeper-backup-daemon ghcr.io:443/netcracker/qubership-zookeeper-backup-daemon:main,deployment zookeeper-integration-tests-runner zookeeper-integration-tests-runner ghcr.io:443/netcracker/qubership-zookeeper-integration-tests:main"
          EOF
          HELM_ARGS="$HELM_ARGS -f /tmp/monitored-images-values.yaml"
          
          # AWS EKS configuration
          # Use temp file to avoid shell escaping issues
          cat > /tmp/aws-values.yaml << 'EOF'
          global:
            tls:
              enabled: false
            securityContext:
              fsGroup: 1000
          zooKeeper:
            tls:
              enabled: false
            storage:
              className:
                - gp2
            resources:
              requests:
                cpu: 50m
                memory: 256Mi
              limits:
                cpu: 200m
                memory: 512Mi
            securityContext:
              fsGroup: 1000
              runAsUser: 1000
          backupDaemon:
            install: true
            tls:
              enabled: false
            s3:
              enabled: true
              url: "https://s3.us-east-1.amazonaws.com"
              bucket: "qstp-zookeeper"
              region: "us-east-1"
            securityContext:
              fsGroup: 1000
          integrationTests:
            affinity: null
          EOF
          HELM_ARGS="$HELM_ARGS -f /tmp/aws-values.yaml"
          
          echo "Helm additional args: $HELM_ARGS"
          
          # Debug: show key values from values.yaml
          echo "=== Debug: Key values ==="
          grep -E "^\s*(install|enabled|prometheusUrl):" ./operator/charts/helm/zookeeper-service/values.yaml | head -20
          echo "========================="
          
          helm install --namespace=${{ vars.ZOOKEEPER_INSTALL_NAMESPACE }} \
            --create-namespace \
            -f ./operator/charts/helm/zookeeper-service/values.yaml \
            zookeeper-service ./operator/charts/helm/zookeeper-service \
            $HELM_ARGS
